import { GoogleGenerativeAI } from "@google/generative-ai";
import { ImageData } from "../types";

const API_KEY = import.meta.env.VITE_GEMINI_API_KEY || "";

export const generateTripStory = async (
  images: ImageData[],
  userKeywords: string
): Promise<string> => {
  if (!API_KEY) {
    throw new Error("Gemini API 키가 설정되지 않았습니다.");
  }

  const genAI = new GoogleGenerativeAI(API_KEY);
  const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

  // 이미지 데이터 준비
  const imageParts = images.map((img) => ({
    inlineData: {
      mimeType: img.mimeType,
      data: img.base64.split(",")[1],
    },
  }));

  const systemInstruction = `당신은 14장의 사진을 분석하여 호치민 출장 기록을 완성하는 전문 비즈니스 라이터입니다.

[절대 준수 규칙]
1. 제목: 반드시 "제목: "으로 시작하고, 키워드 '${userKeywords}'와 "노보텔 사이공센터"를 모두 포함해야 합니다.
2. 본문: 정확히 16개의 문단을 작성하며, 각 문단은 "1. ", "2. " 형식으로 숫자 시작
3. 사진 기반: 14장의 사진을 순서대로 분석하여 2~15번 문단에 1:1 대응
4. 키워드 배치: 정확히 5회 배치 (서론 1회, 본론 3회, 결론 1회)

[제목 작성 규칙 - 매우 중요]
- "제목: "으로 시작
- 키워드 '${userKeywords}'와 "노보텔 사이공센터" 반드시 포함
- 구절 형태 우선: 감각적이고 매력적인 구절로 작성 (예: "호치민의 열기, 노보텔 사이공센터에서의 비즈니스와 쉼")
- 문장 형태 허용: 구절이 어렵다면 문장으로 작성 가능하지만, 마침표(.) 절대 금지
- 내용에 따라 다르게: 사진의 분위기, 여정의 특징, 감정을 반영하여 매번 새로운 제목 작성
- 제목의 길이: 15~40자 범위 (너무 짧지도, 길지도 않게)
- 제목은 본문의 핵심을 담아야 함

[구조]
- 1번 문단: 서론 (여정의 시작, 첫 인상) - 키워드 포함 ①
- 2~15번 문단: 각각 사진 1장에 대응하는 본문 (각 100~150자) - 3회 키워드 포함 ②③④
- 16번 문단: 결론 (여정의 마무리, 감동) - 키워드 포함 ⑤

[키워드 배치 방식]
- ①${userKeywords}: 1번 문단 중간~후반부에 자연스럽게 삽입
- ②${userKeywords}: 2~5번 문단 중 한 곳에 자연스럽게 삽입
- ③${userKeywords}: 6~10번 문단 중 한 곳에 자연스럽게 삽입
- ④${userKeywords}: 11~15번 문단 중 한 곳에 자연스럽게 삽입
- ⑤${userKeywords}: 16번 문단의 마지막 1~2문장에 자연스럽게 삽입

[가독성 극대화]
- 문장 길이 변주: 짧은 문장(10~15자)과 긴 문장(40~60자)을 섞어서 리듬감 있게
- 종결어미 다양화: ~요(50%), ~죠(20%), ~습니다(20%), ~었다(10%)
- 과거형 통일: 모든 문장을 과거형으로 작성
- 1인칭 제거: "나", "저", "우리" 등 사용 금지
- 문단 간 자연스러운 흐름: 각 문단이 독립적이면서도 전체 여정으로 연결
- 감각적 표현: 시각, 청각, 후각, 미각, 촉각을 활용한 생생한 묘사
- 문장의 리듬: 주어-술어 구조를 다양하게 하여 단조로움 방지

[문법 정확성]
- 주어-술어 명확성: 모든 문장의 주어와 술어가 명확해야 함
- 조사 정확성: 은/는, 이/가, 을/를, 에/에게 등 정확한 사용
- 문장 연결: 문장 간 논리적 연결이 자연스러워야 함
- 띄어쓰기: 정확한 띄어쓰기 준수
- 시제 일관성: 과거형으로 통일

[절대 금지]
- 마크다운 형식 사용 금지
- 원숫자 기호 없이 키워드만 사용하지 말 것 (반드시 ①②③④⑤ 함께 사용)
- 제목에 마침표(.) 금지
- 불필요한 이모지나 특수문자 사용 금지
- 제목에 느낌표(!) 사용 금지 (마침표와 같은 종결 기호 금지)

[키워드 문장 다양성 - 매우 중요]
- 5개의 키워드 문장이 서로 다른 문맥과 표현으로 작성되어야 함
- 같은 구조나 표현의 문장이 반복되면 안 됨
- 각 키워드 문장은 그 문단의 내용과 자연스럽게 어울려야 함
- 예시 (피해야 할 유사한 표현):
  ❌ "호치민의 열기를 느꼈다"
  ❌ "호치민의 열기가 느껴졌다"
  ❌ "호치민의 열기를 경험했다"
  ❌ "호치민의 열기가 있었다"
  ❌ "호치민의 열기를 만났다"
- 올바른 다양한 표현:
  ✅ "호치민의 열기 속에서 새로운 기회를 발견했다"
  ✅ "이곳의 에너지는 호치민의 열기 그 자체였다"
  ✅ "호치민의 열기가 비즈니스에 활력을 불어넣었다"
  ✅ "호치민의 열기와 함께 성장하는 경험을 했다"
  ✅ "호치민의 열기는 앞으로의 여정을 밝혀주었다"`;

  const userPrompt = `다음 14장의 사진을 순서대로 분석하여 호치민 출장 후기를 완성해주세요.

[작성 지침]

1. 제목 작성 (매우 중요)
   - "제목: "으로 시작
   - 키워드 '${userKeywords}'와 "노보텔 사이공센터" 반드시 포함
   - 구절 형태 우선 (감각적이고 매력적인 구절)
   - 문장 형태 허용하되, 마침표 절대 금지
   - 사진의 분위기와 내용을 반영하여 독창적으로 작성
   - 예시:
     * 구절 형태: "호치민의 열정, 노보텔 사이공센터에서의 비즈니스 여정"
     * 문장 형태: "노보텔 사이공센터에서 만난 호치민의 또 다른 매력"

2. 본문 작성 (정확히 16문단)
   - 각 문단은 "1. ", "2. " 등으로 시작
   - 1번: 서론 (여정의 시작, 첫 인상) - 키워드 ①${userKeywords} 포함
   - 2~15번: 각각 사진 1장씩 분석 (각 100~150자)
     * 2~5번 중 한 곳: 키워드 ②${userKeywords} 포함
     * 6~10번 중 한 곳: 키워드 ③${userKeywords} 포함
     * 11~15번 중 한 곳: 키워드 ④${userKeywords} 포함
   - 16번: 결론 (여정의 마무리, 감동) - 키워드 ⑤${userKeywords} 포함

3. 가독성 최적화
   - 문장 길이를 다양하게 (짧은 문장과 긴 문장 섞기)
   - 종결어미를 자연스럽게 섞기 (~요, ~죠, ~습니다, ~었다)
   - 과거형으로 통일
   - 1인칭 표현 제거
   - 감각적이고 생생한 표현 사용
   - 각 문단이 독립적이면서도 전체 여정으로 연결

4. 문법 및 표현
   - 모든 문장의 주어-술어가 명확해야 함
   - 조사 사용이 정확해야 함
   - 문장 간 논리적 연결이 자연스러워야 함
   - 띄어쓰기 정확

5. 최종 확인
   - 정확히 16개 문단 (1~16번)
   - 키워드 정확히 5회 배치 (①②③④⑤)
   - 모든 문장이 과거형
   - 1인칭 표현 없음
   - 마크다운 형식 없음
   - 제목에 마침표 없음
   - 5개의 키워드 문장이 서로 다르고 유사하지 않음 (매우 중요)
   - 각 키워드 문장이 그 문단의 내용과 자연스럽게 어울림

이제 14장의 사진을 분석하여 위의 모든 규칙을 따르는 호치민 출장 후기를 작성해주세요.`;

  try {
    const response = await model.generateContent({
      contents: [
        {
          parts: [
            ...imageParts,
            {
              text: userPrompt,
            },
          ],
        },
      ],
      generationConfig: {
        temperature: 0.8,
        topP: 0.9,
        maxOutputTokens: 5000,
      },
      systemInstruction,
    });

    const text = response.response.text();
    if (!text) throw new Error("생성된 내용이 없습니다.");
    return text;
  } catch (error) {
    console.error("Gemini API 오류:", error);
    throw error;
  }
};
