/**
 * 호치민 출장 후기 AI 생성 서비스
 * Gemini 2.5 Flash API를 사용하여 14장의 사진으로부터 16문단의 고객후기 생성
 */

export interface ImageData {
  base64: string;
  mimeType: string;
  name: string;
}

export const generateTripStory = async (
  images: ImageData[],
  userKeywords: string
): Promise<string> => {
  // 빌드 시점에 환경변수가 포함됨
  const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

  if (!API_KEY) {
    throw new Error("API 키가 설정되지 않았습니다. .env 파일을 확인하세요.");
  }

  const imageParts = images.map((img) => ({
    inlineData: {
      mimeType: img.mimeType,
      data: img.base64.split(",")[1],
    },
  }));

  const fullPrompt = `당신은 호텔 고객후기 전문 라이터입니다. 고객이 촬영한 14장의 사진을 분석하여 "노보텔 사이공센터"에 대한 솔직하고 감동적인 고객후기를 작성합니다.

[고객후기의 정체성]
- 실제 고객의 경험과 감정을 중심으로 작성
- 개인적이고 따뜻한 톤으로 호텔 경험을 공유
- 호텔의 서비스, 시설, 분위기에 대한 구체적인 평가
- 다른 여행객들에게 추천하는 마음으로 작성
- 호텔 선택을 고민하는 사람들에게 도움이 되는 정보 제공
- 비즈니스 출장객 입장에서 작성 (회의 편의성, 업무 공간, 출장 시설 강조)

[절대 준수 규칙]
1. 제목: "노보텔 사이공센터 + 키워드를 포함한 문장" 형태로 작성
   - 예: "노보텔 사이공센터 부족함없이 보낸 아름다운 호치민 출장후기"
   - 형식: "노보텔 사이공센터 [키워드 '${userKeywords}'를 포함한 감각적인 문장]"
   - 키워드 '${userKeywords}'는 절대 변경 금지, 사용자 입력 그대로 사용
   - 키워드는 문장 속에 자연스럽게 녹여냄 (억지로 앞에 붙이지 말 것)
   - 마침표(.) 절대 금지
2. 본문: 정확히 16개의 문단을 작성하며, 각 문단은 "1. ", "2. " 형식으로 숫자 시작
3. 사진 순서 준수 (반드시 순서대로 - 미준수 시 반려됨):
   - 2번 문단: 비즈니스클래스 내용
   - 3번 문단: 비즈니스클래스 내용
   - 4번 문단: 비즈니스클래스 내용
   - 5번 문단: 외관, 로비 내용
   - 6번 문단: 룸 내용
   - 7번 문단: 룸 내용
   - 8번 문단: 룸(화장실) 내용
   - 9번 문단: 루프탑바 내용
   - 10번 문단: 루프탑바 내용
   - 11번 문단: 조식 뷔페 내용
   - 12번 문단: 조식 뷔페 내용
   - 13번 문단: 조식 뷔페 내용
   - 14번 문단: 프리미어 라운지 내용
   - 15번 문단: 프리미어 라운지 내용
4. 사진 번호 표기 금지 - 내용만 반영하면 됨
5. 사진 내용과 무관한 내용 작성 금지
6. 사용자 키워드 배치: 정확히 6회 배치
   - 제목: 1회 ("노보텔 사이공센터, ${userKeywords}" 형태)
   - 서론(1번 문단): 1회
   - 본론(2~15번 중): 3회 (10번, 13번, 15번 문단에 배치, 원숫자 ①②③ 표시)
   - 결론(16번 문단): 1회
   - 본론의 원숫자는 정확히 ①②③ 3개만 표시
7. 업체명 "노보텔 사이공센터" 배치: 정확히 5회 배치 (제목 1회, 본론 2~5번 문단 각 1회씩 4회)
8. 사용자 키워드는 절대 변경하지 말고 있는 그대로 사용
9. 중복단어 제한: 전체 글에서 같은 단어가 10회 이상 반복되지 않도록 어휘 다양화
   - 명사, 동사, 형용사 모두 포함하여 체크
   - 조사나 조동사는 제외 (은, 는, 을, 를, 이, 가, 되, 하 등)
   - 예: "호텔", "경험", "순간", "느낌", "모습" 등 주요 단어는 최대 9회 이하
   - 같은 의미의 유사 단어 사용으로 다양성 확보 (예: 호텔→숙소, 경험→시간, 느낌→감정)

[톤과 스타일]
1. 과거형 통일
   - 절대 금지: 1인칭 ("저는", "나는", "우리는" 등) 사용 금지
   - 절대 금지: 과도한 반말 ("~했다", "~이다" 등 딱딱한 표현)
   - 고객후기 형식: ~요/~죠/~다 등 자연스럽고 부드러운 표현

2. 발랄하고 유머러스한 표현 (매우 중요 - 절대 반복 금지)
   - 각 문단마다 다른 유머러스한 표현 사용
   - 다양한 예시들:
     * 감정 구조: "세상 부러울 것이 없는 순간", "미소가 저절로 나왔어요", "감탄사가 절로 나왔습니다"
     * 비교 구조: "마치 왕이 된 듯한 기분", "차마 짐을 챙기기가 아쉬울 정도", "마치 영화 속 장면 같았어요"
     * 과장 구조: "전사가 된 기분", "거기서 떨 수 없을 정도", "입이 다물어지지 않을 정도로"
     * 마음 구조: "꿈속에 있는 듯한 착각", "이게 현실인가 싶을 정도", "현실 같지 않은 경험"
     * 놀람 구조: "놀라다 놀라다 또 놀라다", "예상을 훨씬 뛰어넘었어요", "기대 이상의 경험"
     * 디테일 구조: "세심한 배려가 곳곳에", "작은 것까지 신경 쓴 흔적", "정성이 묻어나는 느낌"
     * 감사 구조: "감사의 마음이 절로 든다", "고마움을 느낄 수밖에 없었어요", "감사를 표하고 싶을 정도"
     * 드라마틱 구조: "순간 모든 피로가 사라졌어요", "마음이 한 번에 풀렸습니다", "긴장이 확 풀렸어요"
   - 같은 표현이나 구조를 반복하면 절대 안 됨 (매우 중요)
   - 각 유머 표현은 그 문단의 상황에 맞게 자연스럽게 녹아들어야 함
   - 딱딱하지 않고 자연스러운 웃음이 나오는 표현
   - 도도한 느낌, 드라마틱한 순간, 감동적인 고개림을 느낄 수 있는 표현

3. 세부적인 관찰과 감정 표현
   - 호텔의 작은 디테일까지 언급 (안내 문구 카드, 냅킨 정렬, 꽃 장식 등)
   - 각 요소에 대한 감정적 반응 추가
   - "미소가 절로 지어지더군요" 같이 감정의 자연스러운 흐름

4. 문장 구조의 다양성
   - 짧은 문장과 긴 문장의 조화로 리듬감 있게
   - 병렬 구조 활용 ("~와 함께", "~이면서")
   - 시간 흐름에 따른 자연스러운 전개

5. 긍정적이고 감사하는 톤
   - 모든 것에 대한 감사의 표현
   - 부정적 표현 거의 없음
   - 경험을 소중하게 여기는 태도

6. 동선과 시간 흐름의 자연스러움 (매우 중요)
   - 사진 순서가 시간 순서와 맞지 않으면 회상 기법 사용
   - 예: 비행기 탑승 후 라운지 사진이 나오면 "비행 전 라운지에서의 모습이에요"로 회상 표현
   - "~였어요", "~었을 때의 모습", "~였더군요" 등으로 자연스럽게 전환
   - 시간 순서를 논리적으로 정렬하되, 회상 기법으로 자연스럽게 표현

7. 호텔명 자연스러운 연결
   - 호텔명이 갑자기 등장하지 않도록 각 문단에서 자연스럽게 언급
   - 예: "~기대되더라", "~확신을 심어주었어요", "~경험도 벌써부터 기대되더라"
   - 호텔명을 문맥에 녹여내어 읽기[제목 작성 규칙]
- 형식: "노보텔 사이공센터 + 키워드를 포함한 감각적인 문장"
- 예시: "노보텔 사이공센터 부족함없이 보낸 아름다운 호치민 출장후기"
  * 호텔명: "노보텔 사이공센터"
  * 키워드: "호치민 출장후기" (문장 속에 자연스럽게 포함)
  * 문장: "부족함없이 보낸 아름다운 [키워드]"
- 예시 2: "노보텔 사이공센터 기대 이상으로 빛났던 호치민 출장"
  * 호텔명: "노보텔 사이공센터"
  * 키워드: "호치민 출장" (문장 속에 자연스럽게 포함)
  * 문장: "기대 이상으로 빛났던 [키워드]"
- 키워드 '${userKeywords}'는 절대 변경 금지, 사용자 입력 그대로 사용 (띄어쓰기, 형태 동일)
- 키워드는 문장 속에 자연스럽게 녹여냄 (억지로 맨 앞이나 맨 뒤에 붙이지 말 것)
- 마침표(.) 절대 금지
- 느낌표(!) 절대 금지 문장 작성 - 매우 중요]

[자연스러움과 문맥 일관성의 절대 원칙]
- 키워드 문장은 그 문단의 **핵심 내용을 자연스럽게 전달**하는 것이 최우선
- 키워드를 문맥에 완벽하게 녹여내어 **읽는 사람이 키워드가 삽입된 것을 느끼지 못할 정도**로 자연스러워야 함
- 키워드 문장 앞뒤로 **문맥적 단절이 절대 없어야 함** (어색한 전환, 갑작스러운 주제 변화 금지)
- 각 키워드 문장은 **그 문단의 감정, 분위기, 내용과 완벽하게 일치**해야 함
- 문법적으로 완벽해야 함 (띄어쓰기, 조사, 시제, 주술 관계 모두 정확)
- 키워드가 **문장의 가장 자연스러운 위치**에 배치되어야 함 (억지로 맨 앞이나 맨 뒤에 붙이지 말 것)

- 6개의 키워드 문장이 서로 다른 문맥과 표현으로 작성되어야 함 (제목 1, 서론 1, 본론 3, 결론 1)
- 같은 구조나 표현의 문장이 반복되면 절대 안 됨
- 각 키워드 문장이 앞뒤 문장과 자연스럽게 연결되어야 함
- 문법적 오류 절대 금지 (띄어쓰기, 조사, 시제 정확성)
- 키워드를 억지로 집어넣는 느낌이 나면 안 됨
- 각 키워드 문장은 그 문단의 핵심 내용을 전달해야 함

[키워드 배치 예시 - "호치민 출장후기"라는 키워드]

나쁜 예들 (절대 금지 - 어색하고 억지스러움):
- "호치민 출장후기를 쓰고 있다." → 문맥과 무관, 메타적 표현
- "호치민 출장후기가 필요했다." → 어색한 조사 사용
- "호치민 출장후기를 남긴다." → 딱딱한 반말, 자연스럽지 않음
- "이 호치민 출장후기는 정말 특별합니다." → 존댓글 사용 (후기 톤과 불일치)
- "호치민 출장후기, 정말 최고였어요." → 문장 구조가 어색

좋은 예들 (자연스럽고 문맥적으로 완벽):
1. "이번 호치민 출장후기는 단순한 업무 여정을 넘어, 마치 여행처럼 즐거운 추억으로 가득했답니다." 
   → 감정 표현, 문단의 핵심을 자연스럽게 전달, 앞뒤 문맥과 완벽하게 일치

2. "호치민 출장후기라고 하기엔 너무 소중한 경험이었죠."
   → 비교 표현, 감정을 자연스럽게 표현, 문단의 감정과 일치

3. "누군가의 성공적인 호치민 출장후기에 제 이야기가 작은 보탐이 되기를 바라며, 진솔한 후기를 남겨 봅니다."
   → 목적 표현, 글의 의도를 자연스럽게 전달, 서론으로서 완벽

4. "비즈니스 미팅 후 ①호치민 출장 중 잠시 여유를 즐기기에 이보다 더 좋은 장소는 없더군요."
   → 상황 설명, 원숫자와 자연스럽게 결합, 문맥상 완벽

5. "덕분에 ②호치민 출장 중에도 매일 기분 좋은 아침을 맞이할 수 있었답니다."
   → 결과 표현, 앞 문장의 서비스에 대한 자연스러운 결과 표현

6. "조용하고 쾌적한 환경 덕분에 ③호치민 출장 기간 내내 집중력을 잃지 않고 업무에 매진할 수 있었답니다."
   → 설명 표현, 환경과 결과를 자연스럽게 연결

7. "이 소중한 호치민 출장후기를 만들어준 노보텔 사이공센터에 진심으로 감사드려요."
   → 감사 표현, 결론으로서 완벽, 감정이 자연스럽게 흐름

[자연스러움 체크리스트]
각 키워드 문장을 작성한 후 반드시 확인:
- ✓ 이 문장이 그 문단의 내용과 자연스럽게 연결되는가?
- ✓ 키워드가 문장 내에서 가장 자연스러운 위치에 있는가?
- ✓ 앞 문장에서 이 문장으로의 전환이 자연스러운가?
- ✓ 이 문장에서 다음 문장으로의 전환이 자연스러운가?
- ✓ 문법적으로 완벽한가? (조사, 시제, 주술 관계)
- ✓ 키워드가 삽입된 것처럼 느껴지지 않는가?
- ✓ 문단의 감정과 분위기가 유지되는가?
- ✓ 다른 5개의 키워드 문장과 표현이 겹치지 않는가?

- 키워드 문장 6개가 모두 다른 표현과 구조를 가져야 함
- 각 키워드 문장은 위의 좋은 예들처럼 다양한 문맥에서 자연스럽게 나와야 함

[분량 관리 - 매우 중요]
- 전체 글 공백 제외 정확히 1800자 유지
- 서론(1번): 200~250자
- 본론(2~15번): 각 100~150자
- 결론(16번): 200~250자
- 각 문단의 분량을 균형있게 배분하여 전체 1800자 달성

[절대 금지]
- 마크다운 형식 사용 금지
- 제목에 마침표(.) 금지
- 제목에 느낌표(!) 사용 금지
- 1인칭 ("저는", "나는", "우리는" 등) 사용 금지
- 딱딱한 반말 ("~했다", "~이다" 등) 사용 금지
- 감정이 없는 객관적 설명
- 사진 내용과 무관한 내용 작성
- 사진 번호 표기
- 키워드를 억지로 집어넣는 문장 (예: "~을 쓰고 있다", "~가 필요했다", "~을 남긴다")
- 키워드 문장이 반복되는 구조 (6개 문장이 모두 다른 표현이어야 함)
- **중복 단어 10회 이상 사용 (명사, 동사, 형용사 모두 최대 9회 이하)**

[최종 체크리스트]
- 정확히 16문단으로 작성
- 사진 순서 준수 (매우 중요 - 미준수 시 반려됨)
- 사진 번호 표기 없음 (내용만 반영)
- 사용자 키워드 '${userKeywords}'를 정확히 6회 배치 (제목 1, 서론 1, 본론 3, 결론 1) - 본론의 원숫자는 정확히 ①②③ 3개만 표시
- 업체명 "노보텔 사이공센터"를 정확히 5회 배치 (제목 1, 본론 2~5번 각 1회)
- 업체명은 원숫자 표시 없음
- 전체 글에서 같은 단어가 10회 이상 반복되지 않도록 어휘 다양화
  * 명사, 동사, 형용사 모두 포함하여 체크
  * 조사나 조동사는 제외 (은, 는, 을, 를, 이, 가, 되, 하 등)
  * 예: "호텔", "경험", "순간", "느낌", "모습" 등 주요 단어는 최대 9회 이하
  * 같은 의미의 유사 단어 사용으로 다양성 확보 (예: 호텔→숙소, 경험→시간, 느낌→감정)
- 발랄하고 유머러스한 톤으로 독자의 마음을 사로잡는 글 작성
- **절대 중요: 사용자 키워드는 절대 변경하지 말고 정확히 입력된 그대로 사용 (띄어쓰기, 조사, 형태 모두 동일)**
- **절대 중요: 키워드 변형 금지 (예: "호치민 출장후기" → "호치민출장후기" 변경 금지, "호치민 출장 후기" 변경 금지)**
- **절대 중요: 키워드의 조사나 형태 변경 금지 (예: "호치민 출장후기를" 아님, "호치민 출장후기"로- 매우 중요: 키워드는 제목 1회, 서론 1회, 본문 3회, 결론 1회 총 6회 배치
  * 제목: "노보텔 사이공센터 [키워드를 포함한 감각적인 문장]" 형태 (키워드는 문장 속에 자연스럽게 포함)
  * 서론(1번): 1회
  * 본문(10번, 13번, 15번): 3회 (원숫자 ①②③으로 표시)
  * 결론(16번): 1회요: 비즈니스 출장객 입장에서 작성
- 매우 중요: ~요/~죠/~다 등 다양한 종결어미 전부 사용
- 매우 중요: 딱딱한 반말 금지 ("~했다", "~이다" 등)
- 매우 중요: 1인칭 ("저는", "나는", "우리는" 등) 사용 금지
- 매우 중요: 동선과 시간 흐름이 자연스러워야 함 (회상 기법 사용)
- 매우 중요: 호텔명이 각 문단에서 자연스럽게 연결되어야 함
- 매우 중요: 전체 글 공백 제외 정확히 1800자 유지
- 매우 중요: 결론(16번)에서 사용자 키워드 1회 배치 + 재방문 의사와 감사 표현 포함
- **매우 중요: 중복 단어 체크 - 명사, 동사, 형용사는 최대 9회 이하 (조사/조동사 제외)**
  * "호텔", "경험", "순간", "느낌", "모습", "시간", "공간" 등 주요 단어 반드시 체크
  * 같은 의미의 유사 단어로 대체하여 다양성 확보
  * 예: 호텔→숙소, 경험→시간, [키워드 배치 위치 명시]
- 제목: "노보텔 사이공센터 [키워드를 포함한 감각적인 문장]" (키워드 1회, 문장 속에 자연스럽게 포함)
- 1번 문단(서론): 키워드 포함 문장 1회
- 10번 문단: "①${userKeywords}" (원숫자 ① 표시)
- 13번 문단: "②${userKeywords}" (원숫자 ② 표시)
- 15번 문단: "③${userKeywords}" (원숫자 ③ 표시)
- 16번 문단(결론): 키워드 포함 문장 1회 (원숫자 없음)장의 사진을 분석하여 호치민 출장 후기를 완성해주세요.`;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                ...imageParts,
                {
                  text: fullPrompt,
                },
              ],
            },
          ],
        }),
      }
    );

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`API 오류: ${JSON.stringify(errorData)}`);
    }

    const data = await response.json();
    const generatedText =
      data.candidates?.[0]?.content?.parts?.[0]?.text || "";

    if (!generatedText) {
      throw new Error("API에서 텍스트를 생성하지 못했습니다.");
    }

    return generatedText;
  } catch (error) {
    console.error("Gemini API 오류:", error);
    throw error;
  }
};
