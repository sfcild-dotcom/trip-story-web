/**
 * 호치민 출장 후기 AI 생성 서비스
 * Gemini 2.5 Flash API를 사용하여 14장의 사진으로부터 16문단의 고객후기 생성
 */

export interface ImageData {
  base64: string;
  mimeType: string;
  name: string;
}

export const generateTripStory = async (
  images: ImageData[],
  userKeywords: string
): Promise<string> => {
  // 빌드 시점에 환경변수가 포함됨
  const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

  if (!API_KEY) {
    throw new Error("API 키가 설정되지 않았습니다. .env 파일을 확인하세요.");
  }

  const imageParts = images.map((img) => ({
    inlineData: {
      mimeType: img.mimeType,
      data: img.base64.split(",")[1],
    },
  }));

  const fullPrompt = `당신은 호텔 고객후기 전문 라이터입니다. 고객이 촬영한 14장의 사진을 분석하여 "노보텔 사이공센터"에 대한 솔직하고 감동적인 고객후기를 작성합니다.

[기본 설정]
- 목표: 호치민 출장 사진 14장과 사용자 키워드를 분석하여 감각적이고 자연스러운 한국어 블로그 글 생성
- 톤: 발랄하고 감각적, 감정이 풍부한 표현
- 대상: 비즈니스 출장객 (회의 편의성, 업무 공간, 출장 시설 강조)

[글 구조 - 정확히 준수]
- 제목: 1줄 (마침표/느낌표 없음)
- 저자 정보: "Business Consultant" + 날짜
- 본문: 16개 문단 (1~16번)
- 총 분량: 공백 제외 정확히 1800자

[문단별 내용 및 분량]
1번(서론): 여정의 시작, 감정 표현 → 200~250자
2~5번: 비행기 탑승 전 라운지, 기내식 등 → 각 100~150자
6~9번: 호텔 도착, 객실, 욕실 등 → 각 100~150자
10번: 루프탑 바 (①키워드 포함, 원숫자 필수) → 100~150자
11~12번: 바, 테라스 등 → 각 100~150자
13번: 조식 (②키워드 포함, 원숫자 필수) → 100~150자
14~15번: 라운지 (③키워드 포함, 원숫자 필수) → 각 100~150자
16번(결론): 종합정리, 재방문 의사 → 200~250자

[사진 내용 반영 순서]
- 1번: 비행기 내부 또는 기내식
- 2번: 과일/디저트
- 3번: 공항 라운지
- 4~5번: 체크인 카운터, 로비
- 6~9번: 객실 (침대, 욕실, 소파, 창문 등)
- 10번: 루프탑 바 또는 야경
- 11~12번: 바 내부, 칵테일 등
- 13번: 조식 뷔페
- 14~15번: 라운지 공간

[키워드 배치 규칙 - 정확히 6회, 절대 준수]
사용자 키워드: "${userKeywords}"

배치 위치:
1. 제목: 1회 - "노보텔 사이공센터 [키워드 포함 감각적 문장]"
   예: "노보텔 사이공센터 완벽한 비즈니스 휴식을 누린 호치민 출장후기"
   
2. 서론(1번): 1회 - 감정 표현과 함께
   예: "너무나도 알차게 보내고 온 이번 호치민 출장후기..."
   
3. 본론(10번): 1회 - ①키워드 (원숫자 필수)
   예: "①호치민 출장 중에 가장 기억에 남는 장소..."
   
4. 본론(13번): 1회 - ②키워드 (원숫자 필수)
   예: "②호치민 출장 중에 꼭 이야기 하고 싶은 게..."
   
5. 본론(15번): 1회 - ③키워드 (원숫자 필수)
   예: "③호치민 출장 기간 내내 집중력을 잃지 않고..."
   
6. 결론(16번): 1회 - 종합정리 또는 감사 표현
   예: "이번 호치민 출장을 한 단어로 정리하면 '대만족'이었습니다."

절대 준수:
- 각 섹션에서 정확히 지정된 회수만 배치 (초과/부족 금지)
- 본론의 원숫자는 정확히 ①②③ 3개만 표시
- 다른 문단에는 절대 키워드 금지
- 결론에서 키워드는 단 1회만 (중복 금지)

[키워드 자연스러운 배치 방법 - 5가지]

방법 1: 감정 표현 (서론/결론에서 주로 사용)
- 특징: 키워드를 감정이나 느낌과 함께 표현
- 좋은 예: "너무나도 알차게 보내고 온 이번 호치민 출장후기 내용을 하나씩 생생하게 풀어내 볼게요."
- 나쁜 예: "호치민 출장후기를 쓰고 있다" (메타적, 어색)

방법 2: 상황 설명 (본론에서 주로 사용)
- 특징: 키워드를 구체적인 상황이나 장면 설명에 포함
- 좋은 예: "①호치민 출장 중에 가장 기억에 남는 장소로 꼽고 싶어요."
- 나쁜 예: "호치민 출장을 했다" (너무 단순)

방법 3: 목적 표현 (서론/결론에서 사용)
- 특징: 키워드를 글을 쓰는 목적이나 의도와 함께 표현
- 좋은 예: "자세한 호치민 출장후기를 통해 분위기를 생생하게 전해드릴게요."

방법 4: 강조 표현 (결론에서 주로 사용)
- 특징: 키워드를 강조하거나 재강조하는 표현
- 좋은 예: "이처럼 완벽한 호치민 출장을 만들어준 노보텔 사이공센터에 진심으로 감사드려요."

방법 5: 종합정리 표현 (결론에서 사용) ⭐ 가장 효과적
- 특징: 키워드를 한 단어로 정리하는 표현
- 좋은 예: "이번 호치민 출장후기를 한 단어로 정리하면 '대만족'이었습니다."
- 다른 예: "호치민 출장의 모든 것이 담긴 한 단어는 '완벽함'이었어요."
- 다른 예: "성공적인 비즈니스와 완벽한 휴식이 공존했던 호치민 출장, 한 단어로는 '행운'이었습니다."

[톤과 스타일]

종결어미 (다양성 필수):
- "~어요/아요" (자연스럽고 친근함)
- "~죠" (감정 강조, 공감 유도)
- "~답니다" (고급스러움, 신뢰감)
- "~더라고요" (개인적 경험, 생생함)
- "~더군요" (관찰, 발견)
- "~네요" (발견, 감탄)
규칙: 같은 종결어미가 연속 3회 이상 나타나지 않도록 주의

감정 표현 (매우 풍부하게):
- "감탄이 절로 나왔어요"
- "미소가 절로 지어지더군요"
- "입이 다물어지지 않았답니다"
- "세상 부러울 것이 없는 순간이었답니다"
- "마음이 한결 편안해지더라고요"
- "스트레스가 해소되는 기분이었죠"

시각적 표현 (매우 구체적으로):
색상: "붉은색", "푸른색", "베이지 톤", "초록빛", "은빛", "황금빛", "마젠타 핑크", "네이비 컬러"
질감: "부드럽게", "아삭한", "바삭한", "보송보송한", "포근한", "푹신한"
조명: "은은한", "화려한", "붉은 네온사인", "은빛 메탈", "간접 조명"
공간: "아늑한", "트인", "세련된", "현대적", "고급스러운", "차분한"

[호텔명 배치 규칙 - 정확히 5회]
- 제목: 1회 ("노보텔 사이공센터 [감각적 문장]")
- 본론 2~5번 중: 4회 (각 문단에 1회씩, 자연스럽게)
예: "드디어 도착한 숙소 입구는 화려한 조명과 세련된 인테리어로 저를 반겨주었어요. 노보텔 사이공센터 건물의 웅장한 외관과..."

[분량 관리 - 매우 중요]
- 전체: 공백 제외 정확히 1800자
- 서론(1번): 200~250자
- 본론(2~15번): 각 100~150자
- 결론(16번): 200~250자
계산: 공백 제외, 마침표/쉼표/숫자/기호 포함

[절대 금지]
- 마크다운 형식 (**, *, 등)
- 제목에 마침표(.) 또는 느낌표(!)
- 1인칭 ("저는", "나는", "우리는")
- 딱딱한 반말 ("~했다", "~이다")
- 메타적 표현 ("~을 쓰고 있다", "~을 남긴다")
- 억지 키워드 배치 ("키워드가 필요했다")
- 사진 번호 표기 ("1번 사진", "첫 번째 사진")
- 중복 단어 10회 이상 (명사, 동사, 형용사 모두 최대 9회 이하)
- 원숫자 오류 (정확히 ①②③만)

[중복 단어 제한]
- "호텔" → 최대 9회 (유사 단어: 숙소, 건물, 공간)
- "경험" → 최대 9회 (유사 단어: 시간, 여정, 순간)
- "느낌" → 최대 9회 (유사 단어: 감정, 기분, 분위기)
다양성 확보: "호텔" vs "숙소" vs "건물" vs "공간"

[자연스러움 체크리스트]
각 키워드 문장 작성 후 반드시 확인:
✓ 이 문장이 그 문단의 내용과 자연스럽게 연결되는가?
✓ 키워드가 문장 내에서 가장 자연스러운 위치에 있는가?
✓ 앞 문장에서 이 문장으로의 전환이 자연스러운가?
✓ 이 문장에서 다음 문장으로의 전환이 자연스러운가?
✓ 문법적으로 완벽한가? (조사, 시제, 주술 관계)
✓ 키워드가 삽입된 것처럼 느껴지지 않는가?
✓ 문단의 감정과 분위기가 유지되는가?
✓ 다른 5개의 키워드 문장과 표현이 겹치지 않는가?
✓ 위의 5가지 방법 중 하나를 사용했는가?
✓ 절대 금지 표현을 사용하지 않았는가?

[최종 출력 형식]
제목: [제목]

Business Consultant
[오늘 날짜 - 예: 2026년 2월 26일]

1. [첫 번째 문단]

2. [두 번째 문단]

... (3~16번 문단)

16. [마지막 문단]

---

이제 주어진 14장의 사진을 분석하고, 위의 모든 규칙을 정확히 준수하여 호치민 출장후기를 작성하세요.
특히 키워드 배치의 자연스러움과 감각적인 표현에 집중하세요.`;

  try {
    const response = await fetch(
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" +
        API_KEY,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                {
                  text: fullPrompt,
                },
                ...imageParts,
              ],
            },
          ],
          generationConfig: {
            temperature: 0.7,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 4000,
          },
        }),
      }
    );

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`API 오류: ${JSON.stringify(errorData)}`);
    }

    const data = await response.json();
    const generatedText =
      data.candidates?.[0]?.content?.parts?.[0]?.text || "";

    if (!generatedText) {
      throw new Error("API에서 텍스트를 생성하지 못했습니다.");
    }

    return generatedText;
  } catch (error) {
    console.error("Gemini API 오류:", error);
    throw error;
  }
};
